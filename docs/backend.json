{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the Caissa Chess game.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user.",
          "format": "uuid"
        },
        "telegramId": {
          "type": "string",
          "description": "The Telegram ID of the user."
        },
        "caissaBalance": {
          "type": "number",
          "description": "The user's balance of CAI tokens."
        },
        "divisionId": {
          "type": "string",
          "description": "Reference to the user's current division. (Relationship: User 1:1 Division)"
        },
        "elo": {
          "type": "number",
          "description": "The user's ELO rating."
        },
        "referralCode": {
          "type": "string",
          "description": "The unique referral code for the user."
        },
        "referrerId": {
          "type": "string",
          "description": "Reference to the user who referred this user. (Relationship: User 1:N User)"
        },
        "skinId": {
          "type": "string",
          "description": "Reference to the user's selected skin. (Relationship: User 1:1 Skin)"
        }
      },
      "required": [
        "id",
        "telegramId",
        "caissaBalance",
        "divisionId",
        "elo",
        "referralCode"
      ]
    },
    "Division": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Division",
      "type": "object",
      "description": "Represents a division in the Caissa Chess game.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the division."
        },
        "name": {
          "type": "string",
          "description": "The name of the division (e.g., Pawn, Knight)."
        },
        "minBalance": {
          "type": "number",
          "description": "The minimum CAI balance required for this division."
        },
        "maxBalance": {
          "type": "number",
          "description": "The maximum CAI balance allowed for this division."
        },
        "icon": {
          "type": "string",
          "description": "Reference to the icon representing the division (e.g., URL to an image)."
        }
      },
      "required": [
        "id",
        "name",
        "minBalance",
        "maxBalance",
        "icon"
      ]
    },
    "Match": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Match",
      "type": "object",
      "description": "Represents a chess match between two players.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the match."
        },
        "player1Id": {
          "type": "string",
          "description": "Reference to the first player. (Relationship: User 1:N Match)"
        },
        "player2Id": {
          "type": "string",
          "description": "Reference to the second player. (Relationship: User 1:N Match)"
        },
        "stake": {
          "type": "number",
          "description": "The amount of CAI tokens at stake."
        },
        "winnerId": {
          "type": "string",
          "description": "Reference to the winning player. Null if the match is a draw. (Relationship: User 1:N Match)"
        },
        "startTime": {
          "type": "string",
          "description": "The date and time the match started.",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "description": "The date and time the match ended.",
          "format": "date-time"
        },
        "moves": {
          "type": "array",
          "description": "A list of chess moves in the match.",
          "items": {
            "type": "string"
          }
        },
        "matchType": {
          "type": "string",
          "description": "The type of match (e.g., division match, private match, tournament match)."
        },
        "tournamentId": {
          "type": "string",
          "description": "Reference to the tournament this match belongs to, if applicable. (Relationship: Tournament 1:N Match)"
        }
      },
      "required": [
        "id",
        "player1Id",
        "player2Id",
        "stake",
        "startTime",
        "moves",
        "matchType"
      ]
    },
    "Tournament": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Tournament",
      "type": "object",
      "description": "Represents a tournament in the Caissa Chess game.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the tournament."
        },
        "name": {
          "type": "string",
          "description": "The name of the tournament."
        },
        "startTime": {
          "type": "string",
          "description": "The date and time the tournament starts.",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "description": "The date and time the tournament ends.",
          "format": "date-time"
        },
        "entryFee": {
          "type": "number",
          "description": "The amount of CAI tokens required to enter the tournament."
        },
        "format": {
          "type": "string",
          "description": "The format of the tournament (e.g., single-elimination, round-robin)."
        },
        "prizes": {
          "type": "array",
          "description": "An array of prize amounts for the top finishers.",
          "items": {
            "type": "number"
          }
        },
        "playerIds": {
          "type": "array",
          "description": "References to the players participating in the tournament. (Relationship: User N:N Tournament)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "startTime",
        "endTime",
        "entryFee",
        "format",
        "prizes"
      ]
    },
    "Skin": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Skin",
      "type": "object",
      "description": "Represents a skin for chess pieces and the board.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the skin."
        },
        "name": {
          "type": "string",
          "description": "The name of the skin."
        },
        "description": {
          "type": "string",
          "description": "A description of the skin."
        },
        "price": {
          "type": "number",
          "description": "The price of the skin in CAI tokens."
        },
        "boardTexture": {
          "type": "string",
          "description": "Reference to the board texture file in Firebase Storage."
        },
        "pieceModels": {
          "type": "string",
          "description": "Reference to the folder of 3D piece model files in Firebase Storage."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "price",
        "boardTexture",
        "pieceModels"
      ]
    },
    "Task": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Task",
      "type": "object",
      "description": "Represents a task that a user can complete to earn CAI tokens.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the task."
        },
        "description": {
          "type": "string",
          "description": "A description of the task."
        },
        "reward": {
          "type": "number",
          "description": "The amount of CAI tokens awarded for completing the task."
        },
        "type": {
          "type": "string",
          "description": "The type of task (e.g., daily, weekly)."
        },
        "requirement": {
          "type": "string",
          "description": "The detailed requirement for task completion."
        }
      },
      "required": [
        "id",
        "description",
        "reward",
        "type",
        "requirement"
      ]
    },
    "UserTask": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserTask",
      "type": "object",
      "description": "Represents the status of a task for a specific user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user task."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the user. (Relationship: User 1:N UserTask)"
        },
        "taskId": {
          "type": "string",
          "description": "Reference to the task. (Relationship: Task 1:N UserTask)"
        },
        "completed": {
          "type": "boolean",
          "description": "Indicates whether the task has been completed by the user."
        },
        "completionDate": {
          "type": "string",
          "description": "The date and time the task was completed.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "taskId",
        "completed"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles, including CAI balance, division, ELO, and referral information. Uses path-based ownership for private user data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/divisions/{divisionId}",
        "definition": {
          "entityName": "Division",
          "schema": {
            "$ref": "#/backend/entities/Division"
          },
          "description": "Stores division information, including name, balance ranges, and icons.",
          "params": [
            {
              "name": "divisionId",
              "description": "The unique identifier for the division."
            }
          ]
        }
      },
      {
        "path": "/matches/{matchId}",
        "definition": {
          "entityName": "Match",
          "schema": {
            "$ref": "#/backend/entities/Match"
          },
          "description": "Stores match data, including player IDs, stake, winner, and moves. Includes denormalized 'player1Id' and 'player2Id' for authorization independence.",
          "params": [
            {
              "name": "matchId",
              "description": "The unique identifier for the match."
            }
          ]
        }
      },
      {
        "path": "/tournaments/{tournamentId}",
        "definition": {
          "entityName": "Tournament",
          "schema": {
            "$ref": "#/backend/entities/Tournament"
          },
          "description": "Stores tournament data, including name, start/end times, entry fee, format, and prizes. Includes denormalized 'playerIds' array.",
          "params": [
            {
              "name": "tournamentId",
              "description": "The unique identifier for the tournament."
            }
          ]
        }
      },
      {
        "path": "/skins/{skinId}",
        "definition": {
          "entityName": "Skin",
          "schema": {
            "$ref": "#/backend/entities/Skin"
          },
          "description": "Stores skin data, including name, description, price, and file references.",
          "params": [
            {
              "name": "skinId",
              "description": "The unique identifier for the skin."
            }
          ]
        }
      },
      {
        "path": "/tasks/{taskId}",
        "definition": {
          "entityName": "Task",
          "schema": {
            "$ref": "#/backend/entities/Task"
          },
          "description": "Stores task data, including description, reward, and type.",
          "params": [
            {
              "name": "taskId",
              "description": "The unique identifier for the task."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/tasks/{taskId}",
        "definition": {
          "entityName": "UserTask",
          "schema": {
            "$ref": "#/backend/entities/UserTask"
          },
          "description": "Stores the status of a task for a specific user. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "taskId",
              "description": "The unique identifier for the task."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support a secure and scalable Caissa Chess game, emphasizing authorization independence and clear access patterns.  User data, including balances, division, and referral information is stored under `/users/{userId}`.  Divisions are stored in `/divisions/{divisionId}`. Matches, tournaments, skins, and tasks are stored in their respective root collections, with denormalized user IDs for efficient querying and security rule enforcement. UserTask progress is tracked under `/users/{userId}/tasks/{taskId}`.\n\nTo ensure Authorization Independence (CRITICAL), the design employs denormalization: User-specific data required for authorization in subcollections or related collections is copied to those documents. For example, while matches are stored in a root-level `/matches` collection, the `player1Id` and `player2Id` fields are present, enabling rules to check if `request.auth.uid` matches either player without needing to perform a `get()` operation on the `/users/{userId}` document. Tournament documents denormalize player IDs in the `playerIds` array. The UserTask collection has an explicit `userId` field.\n\nFor QAPs, structural segregation is used:  Data with different access needs is stored in separate collections. User-specific data (e.g., `/users/{userId}/tasks/{taskId}`) is kept separate from global data (e.g., `/divisions`). This ensures that listing operations can be secured effectively.  For collaborative data (e.g., private matches), if a membership map were needed, it would be stored directly in the match document to avoid `get()` calls.\n\nPrivate data uses path-based ownership (`/users/{userId}/...`). Collaborative data, if any, standardizes on denormalized membership. Global roles, if needed, would use existence checks in dedicated collections (e.g., `/roles_admin/{uid}`)."
  }
}